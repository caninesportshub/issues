name: Sync Issues to Private Repos

on:
  issues:
    types: [opened, edited]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse and Mirror Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PRIVATE_REPOS_TOKEN }}  # Your fine-grained PAT
          script: |
            // No need to import or create Octokit — 'github' is already available and authenticated!

            // Get issue details
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const body = issue.data.body || '';
            console.log('Full issue body for debug:', body);  // Logs the raw body — very helpful!

            let platform = 'untriaged';

            // Find the Platform section: ### Platform followed by content until next ###
            const platformSectionMatch = body.match(/###\s*Platform\s*([\s\S]*?)(?=###|$)/i);
            if (platformSectionMatch && platformSectionMatch[1]) {
              // Split lines, trim, remove empties, take first real value
              const lines = platformSectionMatch[1]
                .split('\n')
                .map(l => l.trim())
                .filter(l => l.length > 0);

              if (lines.length > 0) {
                platform = lines[0].toLowerCase();
              }
            }

            console.log(`Detected platform value: "${platform}"`);

            // Determine target repo (update these to your EXACT private repo names!)
            let targetRepo;
            if (platform.includes('web')) {
              targetRepo = 'caninesportshub';  // <-- Confirm this exact name
            } else if (platform.includes('phone') || platform.includes('tablet') || platform.includes('mobile')) {
              targetRepo = 'mobile';  // <-- Confirm this exact name
            } else {
              // Fallback: label in public repo for manual review
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['untriaged']
              });
              console.log('No platform selected - labeled untriaged');
              return;
            }

            // Create mirrored issue in target private repo
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: targetRepo,
              title: `[Public #${context.issue.number}] ${issue.data.title}`,
              body: `Synced from public: ${issue.data.html_url}\n\n${body}`,
              labels: ['synced', 'bug']
            });

            // Optional: add comment on public issue to confirm sync
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `This issue has been mirrored to the **${platform}** private repo for tracking. Thanks!`
            });
