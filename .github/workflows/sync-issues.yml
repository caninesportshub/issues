name: Sync Issues to Private Repos

on:
  issues:
    types: [opened, edited]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse and Mirror Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PRIVATE_REPOS_TOKEN }}  # PAT with access to both private repos
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            // ── Get all labels (case insensitive) ───────────────────────────────
            const labels = issue.data.labels.map(l => l.name.toLowerCase());

            // ── Determine target repo(s) based on platform labels ───────────────
            const targetRepos = new Set();

            if (labels.includes('web')) {
              targetRepos.add('caninesportshub');
            }

            if (labels.includes('android') || labels.includes('ios')) {
              targetRepos.add('mobile');
            }

            // Optional: also support combined label like "mobile" if you ever want to use it
            // if (labels.includes('mobile')) {
            //   targetRepos.add('mobile');
            // }

            // ── Fallback when no platform label is present ───────────────────────
            if (targetRepos.size === 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['untriaged-platform']
              });
              console.log('No platform label (web/android/ios) found → added untriaged-platform');
              return;
            }

            // ── Determine issue type ─────────────────────────────────────────────
            let issueType = 'bug';  // default
            if (labels.includes('enhancement') || labels.includes('feature-request')) {
              issueType = 'enhancement';
            } else if (labels.includes('bug') || labels.includes('bug-report')) {
              issueType = 'bug';
            }

            console.log(`Issue type: ${issueType}`);
            console.log(`Syncing to repo(s): ${[...targetRepos].join(', ')}`);

            const body = issue.data.body || '';
            const publicLink = `Synced from public: ${issue.data.html_url}\n\n`;

            // ── Mirror to each target repo ───────────────────────────────────────
            for (const targetRepo of targetRepos) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: targetRepo,
                title: `[Public #${context.issue.number}] ${issue.data.title}`,
                body: publicLink + body,
                labels: ['synced', issueType]
              });
              console.log(`→ Mirrored to ${targetRepo}`);
            }

            // ── Leave nice comment on public issue ───────────────────────────────
            const syncedTo = [...targetRepos]
              .map(r => `**${r}**`)
              .join(' and ');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body:
                `This issue has been mirrored to the ${syncedTo} private repo` +
                `${targetRepos.size > 1 ? 's' : ''} for development tracking.\n\n` +
                `Thanks for the report!`
            });
