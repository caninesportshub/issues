name: Sync Issues to Private Repos

on:
  issues:
    types: [opened, edited]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse and Mirror Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PRIVATE_REPOS_TOKEN }}  # PAT with access to both private repos
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            // ── Get labels in lowercase for matching + original labels for forwarding ──
            const lowerLabels = issue.data.labels.map(l => l.name.toLowerCase());
            const originalLabels = issue.data.labels; // keep full objects with original name/casing

            // ── Determine target repo(s) based on platform labels ──────────────────────
            const targetRepos = new Set();

            if (lowerLabels.includes('web')) {
              targetRepos.add('caninesportshub');
            }

            if (lowerLabels.includes('android') || lowerLabels.includes('ios')) {
              targetRepos.add('mobile');
            }

            // Fallback when no platform label is present
            if (targetRepos.size === 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['untriaged-platform']
              });
              console.log('No platform label (web/android/ios) found → added untriaged-platform');
              return;
            }

            // ── Determine issue type ──────────────────────────────────────────────────
            let issueType = 'bug';  // default
            if (lowerLabels.includes('enhancement') || lowerLabels.includes('feature-request')) {
              issueType = 'enhancement';
            } else if (lowerLabels.includes('bug') || lowerLabels.includes('bug-report')) {
              issueType = 'bug';
            }

            console.log(`Issue type: ${issueType}`);
            console.log(`Syncing to repo(s): ${[...targetRepos].join(', ')}`);

            const body = issue.data.body || '';
            const publicLink = `Synced from public: ${issue.data.html_url}\n\n`;

            // ── Prepare forwarded mobile platform labels (only ios/android) ───────────
            const platformLabels = originalLabels
              .filter(l => {
                const name = l.name.toLowerCase();
                return name === 'ios' || name === 'android';
              })
              .map(l => l.name); // keep original casing!

            // ── Base labels + forwarded platform labels (only for mobile repo) ────────
            const baseLabels = ['synced', issueType];

            // Mirror to each target repo
            for (const targetRepo of targetRepos) {
              let labelsToApply = [...baseLabels];

              // Only forward ios/android labels to the mobile repo
              if (targetRepo === 'mobile') {
                labelsToApply = [...new Set([...baseLabels, ...platformLabels])]; // dedupe just in case
              }

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: targetRepo,
                title: `[Public #${context.issue.number}] ${issue.data.title}`,
                body: publicLink + body,
                labels: labelsToApply
              });
              console.log(`→ Mirrored to ${targetRepo} with labels: ${labelsToApply.join(', ')}`);
            }

            // ── Leave nice comment on public issue ────────────────────────────────────
            const syncedTo = [...targetRepos]
              .map(r => `**${r}**`)
              .join(' and ');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body:
                `This issue has been mirrored to the ${syncedTo} private repo` +
                `${targetRepos.size > 1 ? 's' : ''} for development tracking.\n\n` +
                `Thanks for the report!`
            });
